openapi: 3.0.0
info:
  title: Board Meeting Request & Voting System - Documents API
  description: Document upload, retrieval, and access control endpoints
  version: 1.0.0
  contact:
    name: UBS Board Solutions
    email: board-solutions@ubs.example.com

servers:
  - url: https://api.ubs.example.com/v1
    description: Production API
  - url: https://api-staging.ubs.example.com/v1
    description: Staging API
  - url: http://localhost:5000/v1
    description: Local development

tags:
  - name: Document Management
    description: Upload, retrieve, and manage meeting documents
  - name: Document Access Control
    description: SEC admin controls document visibility

paths:
  /meetings/{meetingId}/documents:
    post:
      summary: Upload document to meeting
      operationId: uploadDocument
      tags:
        - Document Management
      security:
        - azureAd: []
      parameters:
        - name: meetingId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/DocumentUploadRequest'
      responses:
        '201':
          description: Document uploaded successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DocumentResponse'
        '400':
          description: Invalid file (size, type, etc.)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
        '404':
          description: Meeting not found
        '413':
          description: File too large (max 100MB)

    get:
      summary: List documents for meeting
      operationId: listDocuments
      tags:
        - Document Management
      security:
        - azureAd: []
      parameters:
        - name: meetingId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: sortBy
          in: query
          description: Sort field
          schema:
            type: string
            enum: [uploadedAt, fileName, fileSize]
            default: uploadedAt
        - name: sortOrder
          in: query
          schema:
            type: string
            enum: [asc, desc]
            default: desc
      responses:
        '200':
          description: List of documents accessible to current user
          content:
            application/json:
              schema:
                type: object
                properties:
                  documents:
                    type: array
                    items:
                      $ref: '#/components/schemas/DocumentResponse'
                  total:
                    type: integer
        '401':
          description: Unauthorized
        '404':
          description: Meeting not found

  /meetings/{meetingId}/documents/{documentId}:
    get:
      summary: Get document metadata and download link
      operationId: getDocument
      tags:
        - Document Management
      security:
        - azureAd: []
      parameters:
        - name: meetingId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: documentId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Document metadata with download link
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DocumentDetailResponse'
        '401':
          description: Unauthorized
        '403':
          description: Access denied (document visibility restricted)
        '404':
          description: Document not found

    patch:
      summary: Update document metadata
      operationId: updateDocument
      tags:
        - Document Management
      security:
        - azureAd: []
      parameters:
        - name: meetingId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: documentId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateDocumentRequest'
      responses:
        '200':
          description: Document metadata updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DocumentResponse'
        '401':
          description: Unauthorized
        '403':
          description: Only document uploader or SEC admin can update
        '404':
          description: Document not found

    delete:
      summary: Delete document from meeting
      operationId: deleteDocument
      tags:
        - Document Management
      security:
        - azureAd: []
      parameters:
        - name: meetingId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: documentId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Document deleted
        '401':
          description: Unauthorized
        '403':
          description: Only document uploader or SEC admin can delete
        '404':
          description: Document not found

  /meetings/{meetingId}/documents/{documentId}/download:
    get:
      summary: Download document file
      operationId: downloadDocument
      tags:
        - Document Management
      security:
        - azureAd: []
      parameters:
        - name: meetingId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: documentId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: File content
          content:
            application/octet-stream: {}
        '301':
          description: Redirect to signed Azure Blob Storage URL (expires in 1 hour)
        '401':
          description: Unauthorized
        '403':
          description: Access denied
        '404':
          description: Document not found

  /meetings/{meetingId}/documents/{documentId}/compliance-flag:
    post:
      summary: Flag document as non-compliant (SEC admin only)
      operationId: flagDocumentNonCompliant
      tags:
        - Document Management
      security:
        - azureAd: [SecAdmin]
      parameters:
        - name: meetingId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: documentId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ComplianceFlagRequest'
      responses:
        '200':
          description: Document flagged
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DocumentResponse'
        '401':
          description: Unauthorized or not SEC admin
        '404':
          description: Document not found

  /meetings/{meetingId}/documents/{documentId}/access:
    get:
      summary: Get document access control list (SEC admin only)
      operationId: getDocumentAccess
      tags:
        - Document Access Control
      security:
        - azureAd: [SecAdmin]
      parameters:
        - name: meetingId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: documentId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Document access control list
          content:
            application/json:
              schema:
                type: object
                properties:
                  documentId:
                    type: string
                    format: uuid
                  allowedUsers:
                    type: array
                    items:
                      $ref: '#/components/schemas/UserInfo'
        '401':
          description: Unauthorized or not SEC admin
        '404':
          description: Document not found

    put:
      summary: Set document access control list (SEC admin only)
      operationId: setDocumentAccess
      tags:
        - Document Access Control
      security:
        - azureAd: [SecAdmin]
      parameters:
        - name: meetingId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: documentId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SetDocumentAccessRequest'
      responses:
        '200':
          description: Access control list updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  documentId:
                    type: string
                    format: uuid
                  allowedUsers:
                    type: array
                    items:
                      $ref: '#/components/schemas/UserInfo'
        '400':
          description: Invalid user IDs or other validation error
        '401':
          description: Unauthorized or not SEC admin
        '404':
          description: Document not found

components:
  securitySchemes:
    azureAd:
      type: oauth2
      flows:
        implicit:
          authorizationUrl: https://login.microsoftonline.com/{tenant}/oauth2/v2.0/authorize
          scopes:
            SecAdmin: SEC admin role for compliance and access control

  schemas:
    DocumentUploadRequest:
      type: object
      required:
        - file
      properties:
        file:
          type: string
          format: binary
          description: Document file (PDF, Word, Excel, image, etc.)
        description:
          type: string
          maxLength: 1000
          description: Optional description
        tags:
          type: string
          maxLength: 500
          description: Optional comma-separated tags

    DocumentResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        fileName:
          type: string
        fileType:
          type: string
          example: application/pdf
        fileSizeBytes:
          type: integer
        description:
          type: string
          nullable: true
        tags:
          type: string
          nullable: true
        uploadedBy:
          $ref: '#/components/schemas/UserInfo'
        uploadedAt:
          type: string
          format: date-time
        isComplianceFlagged:
          type: boolean
        complianceFlagReason:
          type: string
          nullable: true
        canAccess:
          type: boolean
          description: Whether current user can access this document

    DocumentDetailResponse:
      allOf:
        - $ref: '#/components/schemas/DocumentResponse'
        - type: object
          properties:
            downloadUrl:
              type: string
              format: uri
              description: Signed URL (expires in 1 hour) or relative endpoint URL
            downloadExpiresAt:
              type: string
              format: date-time

    UpdateDocumentRequest:
      type: object
      properties:
        description:
          type: string
          maxLength: 1000
        tags:
          type: string
          maxLength: 500

    ComplianceFlagRequest:
      type: object
      required:
        - reason
      properties:
        reason:
          type: string
          maxLength: 500
          minLength: 1
          description: Reason for non-compliance flag

    SetDocumentAccessRequest:
      type: object
      required:
        - allowedUserIds
      properties:
        allowedUserIds:
          type: array
          items:
            type: string
            format: uuid
          description: List of user IDs who can access this document

    UserInfo:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        name:
          type: string
        role:
          type: string
          enum: [RegularUser, SecAdmin, ExternalMember]

    ErrorResponse:
      type: object
      properties:
        code:
          type: string
        message:
          type: string
        details:
          type: array
          items:
            type: object

